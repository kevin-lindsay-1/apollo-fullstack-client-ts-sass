steps:
  # Build container
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - -c
      - 'docker build
        --tag "gcr.io/$PROJECT_ID/fullstack-client:latest"
        --cache-from "gcr.io/$PROJECT_ID/fullstack-client:latest"
        --build-arg "REACT_APP_API_URI=$$REACT_APP_API_URI"
        .'
    secretEnv:
      - REACT_APP_API_URI

  # Push container to registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - push
      - gcr.io/$PROJECT_ID/fullstack-client

  # Deploy container and rolling update
  - name: 'gcr.io/cloud-builders/kubectl'
    args:
      - set
      - image
      - deployment/frontend
      - frontend-container=gcr.io/$PROJECT_ID/fullstack-client:latest
    env:
      - CLOUDSDK_COMPUTE_ZONE=us-central1-a
      - CLOUDSDK_CONTAINER_CLUSTER=frontend

# Encrypted variables to pass in at build time, runtime variables/secrets are in deployment configuration
secrets:
  - kmsKeyName: projects/apollo-server-227201/locations/global/keyRings/Client/cryptoKeys/env
    secretEnv:
      REACT_APP_API_URI: CiQAQCQ1fv/NxBtIeYkfF7jI2LQaaCRVq84KJ3MHkt+exzHotk4SRABm4wnPrXqO5KErNzTpVMFqt2ziBev706wx9BF/CsZtCHiR/Y3Tgqkc687iGRkQjfqg9E4fflXWvWGkpYd2axBS4L68
